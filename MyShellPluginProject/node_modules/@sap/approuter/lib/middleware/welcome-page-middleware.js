'use strict';

var xsrfTokenHandler = require('./xsrf-token-handler');
var dynamicRoutingUtils = require('../utils/dynamic-routing-utils');
var urijs = require('urijs');

module.exports = function welcomePage(req, res, next) {
  var welcomeFile = req.routerConfig.appConfig.welcomeFile;
  var url = dynamicRoutingUtils.getCoreUrl (req);
  var newWelcomeFile;
  var newUrl;
  if (welcomeFile && /^\/(\?.*$)?$/.test(url)) {
    var tracer = req.loggingContext.getTracer(__filename);

    if (welcomeFile[0] !== '/') {
      welcomeFile = '/' + welcomeFile;
    }

    tracer.info('x-forwarded-path header: "%s" ', req.headers['x-forwarded-path']);

    if (req.headers['x-forwarded-path']) {
      var parsedXForwardedPath = urijs.parse(req.headers['x-forwarded-path']);
      var prefix = parsedXForwardedPath.path.replace(/\/+$/, ''); // remove trailing slash
      prefix = parsedXForwardedPath.path.startsWith('/') ? prefix : '/' + prefix; // adding leading slash if not present
      newWelcomeFile = prefix + welcomeFile;
      newWelcomeFile = parsedXForwardedPath.query ? newWelcomeFile + '?' + parsedXForwardedPath.query : newWelcomeFile;
    }

    tracer.info('Incoming request: "%s" will use welcome page "%s"', req.url, newWelcomeFile);
    newUrl = newWelcomeFile ? newWelcomeFile :  dynamicRoutingUtils.getFullUrl (req, welcomeFile);

    if (!xsrfTokenHandler.isTokenFetchRequest(req)) {
      res.writeHead(302, { Location: newUrl });
      return res.end();
    }

    req.url = newUrl;
  }
  next();
};
