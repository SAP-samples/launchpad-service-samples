var UI5_VIEW_FILE_SUFFIX = ".view.xml";
var UI5_FRAGMENT_FILE_SUFFIX = ".fragment.xml";

function _shouldRunAnalysis(fileResource) {
    return (fileResource.getPath().endsWith(UI5_VIEW_FILE_SUFFIX) || fileResource.getPath().endsWith(UI5_FRAGMENT_FILE_SUFFIX));
}

var XmlViewReader = require("./ui5Utils/XmlViewReader");
var Ui5MetadataMng = require("./ui5Utils/Ui5MetadataMng");

module.exports = function(validationMetadata) {
    var versionMetadata;
    try {
        //load the static metadata. the version used can be found in Ui5MetadataMng
        versionMetadata = Ui5MetadataMng.loadMetadata(validationMetadata);
    } catch(e) {
        versionMetadata = null;
        throw e;
    }
    return {
        analyse: function (fileResource, bIsIdAttributeRequired) {
            if (versionMetadata === null) {
                return;
            }
            if (!_shouldRunAnalysis(fileResource)) {
                return;
            }
            var ui5SemanticIssuesReport = XmlViewReader.validateXml(
                fileResource, versionMetadata.metadata, bIsIdAttributeRequired);
            return {
                "root": {},
                "issues": ui5SemanticIssuesReport.issues || [],
                "aId": ui5SemanticIssuesReport.aId || []
            };
        }
    };
};
